<link rel="stylesheet" href="/css/user/checkout/checkout.css" />
<style>
  /* ===============================
   Slide-in Toast MSG
=============================== */

  .mobile-alert {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #111;
    color: #fff;
    padding: 12px 20px;
    border-radius: 14px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.35s ease;
    box-shadow: 0 6px 22px rgba(0, 0, 0, 0.25);
    z-index: 9999;
  }

  .mobile-alert.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  button {
    padding: 10px 20px;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
  }

  @media (min-width: 768px) {
    .mobile-alert {
      top: 20px;
      bottom: auto;
      transform: translateX(-50%) translateY(-100px);
    }

    .mobile-alert.show {
      transform: translateX(-50%) translateY(0);
    }
  }

  .message-green {
    color: #00ff7f;
  }

  .message-red {
    color: #ff4d4d;
  }

  .message-yellow {
    color: #ffcc00;
  }

  .success-icon,
  .error-icon {
    font-size: 16px;
    /* same size */
    margin-right: 6px;
    /* space */
    vertical-align: middle;
  }

  .success-icon {
    color: #00ff7f;
    /* green */
  }

  .error-icon {
    color: #dc3545;
    /* red */
  }

  .yellow-icon {
    color: #ffcc00;
    /* red */
  }
</style>
<!-- Slide-in Toast MSG -->
<div id="mobileAlert" class="mobile-alert"></div>
<div class="wrap-container">
  <div class="container">
    <h1>Checkout</h1>

    <div class="stepper-wrapper">
      <div class="stepper">
        <div class="step-item">
          <div class="step active-step">1</div>
          <div class="step-label">Address</div>
        </div>
        <div class="step-item">
          <div class="step active-step">2</div>
          <div class="step-label">Select Payment</div>
        </div>
        <div class="step-item">
          <div class="step active-step">3</div>
          <div class="step-label">Pay</div>
        </div>
        <div class="step-item">
          <div class="step">4</div>
          <div class="step-label">Summary</div>
        </div>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT SIDE -->
      <div>
        <div class="card">
          <h2>Cash on Delivery (Advance Required)</h2>

          <p style="color:#555; margin-bottom:14px;">
            A small advance amount must be paid now. Remaining amount will be collected on delivery.
          </p>

          <label>Advance Amount *</label>

          <div id="advanceAmountBox"
            style="background:#f7f7f7; padding:12px; border-radius:8px; font-weight:600; margin-bottom:16px;">
            ₹ {{formatPrice advanceAmount}}
          </div>
        </div>

      </div>

      <!-- RIGHT SIDE -->
      <div>
        <div class="card summary-card">
          <h3>Order Summary</h3>

          <!-- <div style="display:flex; align-items:center; margin-top:10px;">
            <div><strong>Seat Cover</strong><br><small>Qty: 1</small></div>
          </div> -->

          <div class="summary-row"><span>Price ({{cart.items.length}} items)</span><span>{{formatPrice
              cart.totalAmount}}</span></div>
          <div class="summary-row"><span>Shipping</span><span>Free</span></div>
          {{#if cart.accessoryTax}}
          <div class="summary-row"><span>Tax<span class="fw-semibold">(GST {{taxRate}}% Only for
                Accessory)</span></span><span>₹ {{formatPrice cart.accessoryTax}}</span></div>
          {{else}}
          <div class="summary-row"><span>Tax</span><span>₹ 0</span></div>
          {{/if}}
          {{#if cart.appliedCoupon.code}}
          <div class="d-flex justify-content-between align-items-center mb-3 bg-light p-2 rounded">
            <span class="text-muted">
              Applied Coupon:
              <strong class="text-dark">{{cart.appliedCoupon.code}}</strong>
            </span>

            <div class="d-flex align-items-center gap-2">
              <span class="fw-semibold text-success">
                - ₹{{formatPrice cart.appliedCoupon.couponDiscount}}
              </span>
            </div>
          </div>
          {{/if}}
          <hr>
          <div class="summary-row" style="font-weight:700"><span>Total</span><span>₹ {{formatPrice
              cart.totalAfterAll}}</span></div>
          {{#if cart.discountedPrice}}
          <!-- Savings Banner -->
          <div class="alert alert-success d-flex justify-content-between align-items-center py-2 px-3 mb-3"
            role="alert">
            <span class="fw-semibold text-success" style="font-size: 13px;">
              Your Total Savings on this order
            </span>
            <span class="fw-semibold text-success" style="font-size: 13px;">
              ₹ {{formatPrice cart.discountedPrice}}
            </span>
          </div>
          {{/if}}
          <button class="btn" id="continueBtn" data-cartid="{{cart._id}}">Continue</button>
        </div>
      </div>

    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {

    function showMobileAlert(message, notification) {
      const alertBox = document.getElementById("mobileAlert");
      if (notification === "success") {
        alertBox.innerHTML = `<i class="bi bi-check-circle-fill success-icon"></i><span class="message-green">${message}</span>`;
        alertBox.classList.add("show");
      } else if (notification === "error") {
        alertBox.innerHTML = `<i class="bi bi-x-circle-fill error-icon"></i><span class="message-red">${message}</span>`;
        alertBox.classList.add("show");
      } else if (notification === "warning") {
        alertBox.innerHTML = `<i class="bi bi-exclamation-triangle-fill yellow-icon"></i><span class="message-yellow">${message}</span>`;
        alertBox.classList.add("show");
      }

      setTimeout(() => {
        alertBox.classList.remove("show");
      }, 2000);
    }



    const continueBtn = document.getElementById("continueBtn")
    continueBtn.addEventListener("click", async () => {
      try {
        const cartId = continueBtn.getAttribute("data-cartid");
        const res = await axios.post(`/cart/checkout/create-order/${cartId}`);

        console.log("create-order response:", res.data); // debug

        if (res.data && res.data.success) {
          showMobileAlert("Order created successfully", "success");
          setTimeout(() => {
            window.location.replace(res.data.redirect);
          }, 1000);
        } else {
          const msg = res.data?.message || "Failed to create order";
          showMobileAlert(msg, "error");
        }
      } catch (error) {
        console.error("Create order failed:", error.response?.data || error.message);
        const msg = error.response?.data?.message || "Something went wrong";
        showMobileAlert(msg, "error");
      }

    })
  })
</script>