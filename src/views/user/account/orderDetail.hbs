<style>
  body {
    margin-top: 95px;
  }

  /* ================= WRAPPER ================= */
  .wrap-orderdetail {
    max-width: 1000px;
    background: #f7f7f7;
    padding: 24px 40px 40px;
    border-radius: 12px;
  }

  /* ================= HEADER ================= */
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .page-title {
    font-weight: 700;
    margin: 0;
  }

  .btn-invoice {
    background: #000;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-pay {
    margin-top: auto;
    margin-bottom: 5px;
    height: 40px;
    background: #000;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* ================= SUMMARY ================= */
  .order-summary-box {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    background: #fff;
    padding: 18px;
    border-radius: 12px;
    border: 1px solid #e5e5e5;
    margin-bottom: 24px;
  }

  .os-label {
    font-size: 13px;
    color: #888;
  }

  .os-value {
    font-weight: 600;
    margin-top: 4px;
  }

  /* ================= ADDRESS ================= */
  .address-box {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #e5e5e5;
    line-height: 1.6;
  }

  .section-title {
    font-weight: 600;
    margin: 28px 0 12px;
  }

  /* ================= ITEMS ================= */
  .item-box {
    background: #fff;
    border-radius: 12px;
    border: 1px solid #e5e5e5;
    padding: 16px;
  }

  .user-item-row {
    display: flex;
    gap: 16px;
    padding: 20px 0;
    border-bottom: 1px solid #eee;
    align-items: center;
  }

  .user-item-row:last-child {
    border-bottom: none;
  }

  .user-item-image img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 10px;
    border: 1px solid #e5e5e5;
  }

  .user-item-info {
    flex: 1;
  }

  .user-item-title {
    font-weight: 600;
  }

  .user-item-meta {
    font-size: 14px;
    color: #777;
    margin-top: 4px;
  }

  /* ================= STATUS BADGE ================= */
  .badge-status {
    display: inline-block;
    margin-top: 6px;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    border-radius: 999px;
    text-transform: capitalize;
  }

  .badge-placed {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
  }

  .badge-confirmed {
    background: #e6f4ea;
    color: #137333;
    border: 1px solid #cce8d5;
  }

  .badge-shipped {
    background: #e8f0fe;
    color: #1a73e8;
    border: 1px solid #d2e3fc;
  }

  .badge-out_for_delivery {
    background: #ede7f6;
    color: #5e35b1;
    border: 1px solid #d1c4e9;
  }

  .badge-delivered {
    background: #e6f4ea;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  /* ================= REALISTIC PROGRESS BAR ================= */

  .order-progress {
    margin-top: 12px;
    position: relative;
  }

  /* BASE LINE */
  .progress-track {
    position: absolute;
    top: 7px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e5e5e5;
    border-radius: 4px;
  }

  /* FILL LINE */
  .progress-fill {
    height: 2px;
    width: 0%;
    background: #000;
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  /* NORMAL FLOW */
  .progress-fill.confirmed {
    width: 33%;
  }

  .progress-fill.shipped {
    width: 66%;
  }

  .progress-fill.delivered {
    width: 100%;
  }

  /* STEPS */
  .progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    z-index: 1;
  }

  .step {
    flex: 1;
    text-align: center;
  }

  /* DOT */
  .step-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #cfcfcf;
    margin: auto;
  }

  /* STATES */
  .step.done .step-dot {
    background: #000;
  }

  .step.current .step-dot {
    background: #000;
    box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.08);
  }

  /* LABEL */
  .step-label {
    font-size: 11px;
    margin-top: 4px;
    color: #aaa;
  }

  .step.done .step-label,
  .step.current .step-label {
    color: #000;
    font-weight: 600;
  }

  /* DATE */
  .step-date {
    font-size: 10px;
    color: #999;
    margin-top: 2px;
  }

  /* ================= CANCELLED / RETURNED ================= */

  .order-progress.is-cancelled .progress-fill,
  .order-progress.is-returned .progress-fill {
    width: 0%;
    background: #dc3545;
  }

  .order-progress.is-cancelled .step-dot,
  .order-progress.is-returned .step-dot {
    background: #dc3545;
  }

  .order-progress.is-cancelled .step-label,
  .order-progress.is-returned .step-label {
    color: #dc3545;
    font-weight: 600;
  }

  /* ================= RIGHT SIDE ================= */
  .item-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    min-width: 120px;
  }

  .user-item-price {
    font-weight: 700;
    font-size: 16px;
  }

  /* ================= ACTION BUTTONS ================= */
  .item-action-btn {
    padding: 6px 14px;
    font-size: 13px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    background: #fff;
  }

  .item-action-btn.cancel {
    border: 1px solid #dc3545;
    color: #dc3545;
  }

  .item-action-btn.return {
    border: 1px solid #0d6efd;
    color: #0d6efd;
  }

  .item-action-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* ================= MOBILE ================= */
  @media (max-width: 768px) {
    .order-summary-box {
      grid-template-columns: 1fr 1fr;
    }

    .user-item-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .item-right {
      align-items: flex-start;
    }
  }

  .item-price-box {
    margin-top: 8px;
    padding: 10px 12px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #eee;
    font-size: 13px;
  }

  .price-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    color: #333;
  }

  .price-row:not(:last-child) {
    border-bottom: 1px dashed #e5e7eb;
  }

  .price-row span:last-child {
    font-weight: 600;
  }

  .price-row.offer span:last-child {
    color: #198754;
  }

  .price-row.advance span:last-child {
    color: #0d6efd;
  }

  .price-row.refund span:last-child {
    color: #dc3545;
  }
</style>

<div class="wrap-orderdetail">

  <!-- HEADER -->
  <div class="order-header">
    <div>
      <h3 class="page-title">Order Details</h3>
      <small class="text-muted">Order ID: {{order.orderId}}</small>
    </div>

    <button id="downloadInvoice" class="btn-invoice" data-orderid="{{order._id}}" data-orderedid="{{order.orderId}}"
      data-customername="{{order.address.name}}">
      <i class="bi bi-receipt"></i>
      Invoice
    </button>
  </div>

  <!-- STICKY SUMMARY -->
  <div class="order-summary-box">
    <!-- <div>
      <div class="os-label">Order ID</div>
      <div class="os-value">{{order.orderId}}</div>
    </div> -->

    <div>
      <div class="os-label">Date</div>
      <div class="os-value">{{formattedDate order.createdAt}}</div>
    </div>

    <div>
      <div class="os-label">Total</div>
      <span class="os-value">
        ₹ {{#if order.totalAmount}}
        {{formatPrice order.totalAmount}}
        {{else}}
        0
        {{/if}}
      </span>
    </div>

    <!-- <div>
      <div class="os-label">Total Advance Amount</div>
      <span class="os-value">
        ₹ {{#if order.advanceAmount}}
        {{formatPrice order.advanceAmount}}
        {{else}}
        0
        {{/if}}
      </span>
    </div> -->
    {{#if order.remainingAmount}}
    <div>
      <div class="os-label">Remaining Amount</div>
      <span class="os-value">
        ₹ {{formatPrice order.remainingAmount}}
      </span>
    </div>
    {{/if}}

    {{#if order.totalRefundAmount}}
    <div>
      <div class="os-label">Total Refund Amount</div>
      <span class="os-value">
        ₹ {{formatPrice order.totalRefundAmount}}
      </span>
    </div>
    {{/if}}
  </div>

  <!-- ADDRESS -->
  <h5 class="section-title">Shipping Address</h5>
  <div class="address-box">
    <strong>{{order.address.name}}</strong><br>
    {{order.address.phone}} • {{order.address.email}}<br><br>
    {{order.address.label}}<br>
    {{order.address.street}}<br>
    {{#if order.address.landmark}}{{order.address.landmark}}<br>{{/if}}
    {{order.address.city}}, {{order.address.district}},
    {{order.address.state}} – {{order.address.pincode}}
  </div>

  <!-- ITEMS -->
  <div style="display: flex;justify-content: space-between;">
    <h5 class="section-title">Order Items</h5>
    <button id="downloadInvoice" class="btn-pay" data-orderid="{{order._id}}" data-orderedid="{{order.orderId}}"
      data-customername="{{order.address.name}}">
      <i class="bi bi-credit-card"></i>
      Pay
    </button>
  </div>
  <div class="item-box">
    {{#each order.items}}
    <div class="user-item-row">

      <!-- LEFT IMAGE -->
      <div class="user-item-image">
        {{#if this.carId}}
        <img src="{{this.variantId.image_url.[0]}}">
        {{else}}
        <img src="{{this.accessoryId.images.[0]}}">
        {{/if}}
      </div>

      <!-- CENTER INFO -->
      <div class="user-item-info">

        <div class="user-item-title">
          {{#if this.carId}}{{this.carId.name}}{{else}}{{this.accessoryId.name}}{{/if}}
        </div>

        <div class="user-item-meta">Qty {{this.quantity}}</div>

        <!-- PRICE BREAKDOWN -->
        <div class="item-price-box">

          <div class="price-row">
            <span>Price</span>
            <span>₹ {{formatPrice this.price}}</span>
          </div>

          <div class="price-row">
            <span>Tax</span>
            <span>₹ {{formatPrice this.accessoryTax}}</span>
          </div>

          {{#if this.offerPrice}}
          <div class="price-row offer">
            <span>Offer Price</span>
            <span>₹ {{formatPrice this.offerPrice}}</span>
          </div>
          {{/if}}

          {{#if this.advanceAmount}}
          <div class="price-row advance">
            <span>Advance Paid</span>
            <span>₹ {{formatPrice this.advanceAmount}}</span>
          </div>
          {{/if}}

          {{#if this.cancel.approvedAt}}
          <div class="price-row refund">
            <span>Refunded (Cancelled)</span>
            <span>- ₹ {{formatPrice this.cancel.refundAmount}}</span>
          </div>
          {{/if}}

          {{#if this.return.approvedAt}}
          <div class="price-row refund">
            <span>Refunded (Returned)</span>
            <span>- ₹ {{formatPrice this.return.refundAmount}}</span>
          </div>
          {{/if}}

        </div>


        <!-- ORDER PROGRESS -->
        <div class="order-progress
      {{#if this.cancel.approvedAt}}is-cancelled{{/if}}
      {{#if this.return.approvedAt}}is-returned{{/if}}
    ">

          <div class="progress-track">
            <div class="progress-fill
          {{#if this.fulfillmentStatus.confirmedAt}}confirmed{{/if}}
          {{#if this.fulfillmentStatus.shippedAt}}shipped{{/if}}
          {{#if this.fulfillmentStatus.out_for_deliveryAt}}out_for_delivery{{/if}}
          {{#if this.fulfillmentStatus.deliveredAt}}delivered{{/if}}
        "></div>
          </div>

          <div class="progress-steps">

            <div class="step done">
              <div class="step-dot"></div>
              <div class="step-label">Placed</div>
              <div class="step-date">{{formattedDate this.fulfillmentStatus.placedAt}}</div>
            </div>

            <div class="step {{#if this.fulfillmentStatus.confirmedAt}}done{{/if}}">
              <div class="step-dot"></div>
              <div class="step-label">Confirmed</div>
              {{#if this.fulfillmentStatus.confirmedAt}}
              <div class="step-date">{{formattedDate this.fulfillmentStatus.confirmedAt}}</div>
              {{/if}}
            </div>

            <div class="step {{#if this.fulfillmentStatus.shippedAt}}done{{/if}}">
              <div class="step-dot"></div>
              <div class="step-label">Shipped</div>
              {{#if this.fulfillmentStatus.shippedAt}}
              <div class="step-date">{{formattedDate this.fulfillmentStatus.shippedAt}}</div>
              {{/if}}
            </div>

            <div class="step {{#if this.fulfillmentStatus.out_for_deliveryAt}}done{{/if}}">
              <div class="step-dot"></div>
              <div class="step-label">Out for Delivery</div>
              {{#if this.fulfillmentStatus.out_for_deliveryAt}}
              <div class="step-date">{{formattedDate this.fulfillmentStatus.out_for_deliveryAt}}</div>
              {{/if}}
            </div>

            {{#if this.cancel.approvedAt}}
            <div class="step done cancelled">
              <div class="step-dot"></div>
              <div class="step-label">Cancelled</div>
              <div class="step-date">{{formattedDate this.cancel.approvedAt}}</div>
            </div>
            {{else if this.return.approvedAt}}
            <div class="step done returned">
              <div class="step-dot"></div>
              <div class="step-label">Returned</div>
              <div class="step-date">{{formattedDate this.return.approvedAt}}</div>
            </div>
            {{else}}
            <div class="step {{#if this.fulfillmentStatus.deliveredAt}}done{{/if}}">
              <div class="step-dot"></div>
              <div class="step-label">Delivered</div>
              {{#if this.fulfillmentStatus.deliveredAt}}
              <div class="step-date">{{formattedDate this.fulfillmentStatus.deliveredAt}}</div>
              {{/if}}
            </div>
            {{/if}}

          </div>
        </div>
      </div>

      <!-- RIGHT SIDE -->
      <div class="item-right">

        {{#if this.return.approvedAt}}
        <button class="item-action-btn return" disabled>Return Approved</button>

        {{else if this.return.rejectedAt}}
        <button class="item-action-btn return" disabled>Return Rejected</button>

        {{else if this.return.requested}}
        <button class="item-action-btn return" disabled>Return Requested</button>

        {{else if (eq this.fulfillmentStatus.status "delivered")}}
        {{#if this.carId}}
        <button class="item-action-btn return" disabled>No Return</button>
        {{else}}
        <button class="item-action-btn return" data-orderid="{{../order._id}}" data-itemid="{{this._id}}"
          data-bs-toggle="modal" data-bs-target="#returnModal">
          Return
        </button>
        {{/if}}

        {{else if this.cancel.approvedAt}}
        <button class="item-action-btn cancel" disabled>Cancelled</button>

        {{else if this.cancel.rejectedAt}}
        <button class="item-action-btn cancel" disabled>Cancel Rejected</button>

        {{else if this.cancel.requested}}
        <button class="item-action-btn cancel" disabled>Cancel Requested</button>

        {{else if (eq this.fulfillmentStatus.status "out_for_delivery")}}
        <button class="item-action-btn cancel" disabled>Cancel</button>

        {{else}}
        <button class="item-action-btn cancel" data-orderid="{{../order._id}}" data-itemid="{{this._id}}"
          data-bs-toggle="modal" data-bs-target="#cancelModal">
          Cancel
        </button>
        {{/if}}

        <!-- FINAL ITEM TOTAL -->
        <div class="user-item-price">
          {{#if this.offerPrice}}
          ₹ {{formatPrice this.offerPrice}}
          {{else}}
          ₹ {{formatPrice this.price}}
          {{/if}}
        </div>

      </div>

    </div>
    {{/each}}

  </div>




  <!-- TRACKING -->
  <!-- <h5 class="section-title">Tracking History</h5>
  <div class="tracking-box">
    <div class="track-step">
      <div class="track-dot"></div>
      <div>
        <div class="track-title">Order Placed</div>
        <div class="track-date">{{formattedDate order.createdAt}}</div>
      </div>
    </div>

    {{#if order.deliveredAt}}
    <div class="track-step">
      <div class="track-dot"></div>
      <div>
        <div class="track-title">Delivered</div>
        <div class="track-date">{{formattedDate order.deliveredAt}}</div>
      </div>
    </div>
    {{else}}
    <p class="text-muted small">More tracking updates will appear here.</p>
    {{/if}}
  </div> -->
</div>

<!-- Return order -->
<div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5>Product Return</h5>

        <form id="returnForm" class="mt-3">
          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input class="form-control" name="subject" placeholder="subject">
            <small class="text-danger error-subject d-none">Subject is required</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea class="form-control" rows="6" name="message"></textarea>
            <small class="text-danger error-message d-none">Message is required</small>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-dark">
              <i class="bi bi-send"></i> Request
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
<!-- cancel order -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5>Product Cancel</h5>

        <form id="cancelForm" class="mt-3">
          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input class="form-control" name="subject">
            <small class="text-danger error-subject d-none">Subject is required</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea class="form-control" rows="6" name="message"></textarea>
            <small class="text-danger error-message d-none">Message is required</small>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-dark">
              <i class="bi bi-send"></i> Request
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content text-center p-3">
      <h5 class="mb-2">Request Sent</h5>
      <p class="text-muted mb-2" id="responsMsg"></p>
      <i class="bi bi-check-circle-fill text-success" style="font-size:32px;"></i>
    </div>
  </div>
</div>
<script>
  "use strict";

  /* -----------------------------
     GLOBAL STATE
  ----------------------------- */
  let orderId = null;
  let itemId = null;
  let activeButton = null;
  document.querySelectorAll(".progress-fill").forEach(bar => {
    requestAnimationFrame(() => {
      bar.style.width = bar.classList.contains("delivered")
        ? "100%"
        : bar.classList.contains("out_for_delivery")
          ? "78%"
          : bar.classList.contains("shipped")
            ? "64%"
            : bar.classList.contains("confirmed")
              ? "40%"
              : "0%";
    });
  });

  /* -----------------------------
     MOBILE ALERT
  ----------------------------- */
  function showMobileAlert(message, type) {
    const alertBox = document.getElementById("mobileAlert");
    if (!alertBox) return;

    const icons = {
      success: "bi-check-circle-fill success-icon",
      error: "bi-x-circle-fill error-icon",
      warning: "bi-exclamation-triangle-fill yellow-icon",
    };

    alertBox.innerHTML = `
    <i class="bi ${icons[type] || icons.success}"></i>
    <span>${message}</span>
  `;

    alertBox.classList.add("show");

    setTimeout(() => {
      alertBox.classList.remove("show");
    }, 2000);
  }

  /* -----------------------------
     SUCCESS MODAL
  ----------------------------- */
  function showSuccessModal(msg) {
    const modalEl = document.getElementById("successModal");
    document.getElementById("responsMsg").textContent = msg;

    const modal = new bootstrap.Modal(modalEl, {
      backdrop: "static",
      keyboard: false
    });

    modal.show();
    setTimeout(() => {
      modal.hide();
    }, 2000);


    modalEl.addEventListener(
      "hidden.bs.modal",
      () => {
        if (activeButton) {
          activeButton.focus();
        }
      },
      { once: true }
    );
  }

  /* -----------------------------
     FORM VALIDATION
  ----------------------------- */
  function validateForm(form) {
    let valid = true;

    const subject = form.querySelector('input[name="subject"]');
    const message = form.querySelector('textarea[name="message"]');

    const subjectError = form.querySelector(".error-subject");
    const messageError = form.querySelector(".error-message");

    if (!subject.value.trim()) {
      subject.classList.add("is-invalid");
      subjectError.classList.remove("d-none");
      valid = false;
    } else {
      subject.classList.remove("is-invalid");
      subjectError.classList.add("d-none");
    }

    if (!message.value.trim()) {
      message.classList.add("is-invalid");
      messageError.classList.remove("d-none");
      valid = false;
    } else {
      message.classList.remove("is-invalid");
      messageError.classList.add("d-none");
    }

    return valid;
  }

  /* -----------------------------
     DOM READY
  ----------------------------- */
  document.addEventListener("DOMContentLoaded", () => {

    /* =============================
       INVOICE DOWNLOAD
    ============================= */
    const downloadInvoice = document.getElementById("downloadInvoice");

    if (downloadInvoice) {
      downloadInvoice.addEventListener("click", async () => {
        const orderId = downloadInvoice.dataset.orderid;
        const orderedId = downloadInvoice.dataset.orderedid;
        const customerName = downloadInvoice.dataset.customername;

        try {
          const res = await axios.get(
            `/cart/checkout-success/download-invoice/${orderId}`,
            { responseType: "blob" }
          );

          const blob = new Blob([res.data], { type: "application/pdf" });
          const url = URL.createObjectURL(blob);
          const safeName = customerName?.replace(/[^a-zA-Z0-9]/g, "_") || "Customer";

          const a = document.createElement("a");
          a.href = url;
          a.download = `LUXCART-Invoice-${safeName}-${orderedId}.pdf`;
          document.body.appendChild(a);
          a.click();

          a.remove();
          URL.revokeObjectURL(url);

          showMobileAlert("Invoice downloaded", "success");
        } catch (err) {
          showMobileAlert("Invoice download failed", "error");
        }
      });
    }

    /* =============================
       CAPTURE CANCEL / RETURN BUTTON
    ============================= */
    document.querySelectorAll(".item-action-btn.cancel").forEach(btn => {
      btn.addEventListener("click", () => {
        orderId = btn.dataset.orderid;
        itemId = btn.dataset.itemid;
        activeButton = btn;

        console.log("CANCEL CLICKED:", orderId, itemId);
      });
    });

    document.querySelectorAll(".item-action-btn.return").forEach(btn => {
      btn.addEventListener("click", () => {
        orderId = btn.dataset.orderid;
        itemId = btn.dataset.itemid;
        activeButton = btn;

        console.log("RETURN CLICKED:", orderId, itemId);
      });
    });

    /* =============================
       CANCEL FORM SUBMIT
    ============================= */
    document.getElementById("cancelForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!validateForm(this)) return;

      if (!orderId || !itemId) {
        showMobileAlert("Invalid item selected", "error");
        return;
      }

      const data = Object.fromEntries(new FormData(this).entries());

      try {
        const res = await axios.post(
          `/account/orders/order-details/cancel-request/${orderId}/${itemId}`,
          data
        );

        if (res.data.success) {
          bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
          this.reset();
          showSuccessModal("Cancel request sent");

          // UI UPDATE
          activeButton.textContent = "Cancel Requested";
          activeButton.disabled = true;
          activeButton.style.pointerEvents = "none";
        }
      } catch (err) {
        showSuccessModal("Cancel request failed");
      }
    });

    /* =============================
       RETURN FORM SUBMIT
    ============================= */
    document.getElementById("returnForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!validateForm(this)) return;

      if (!orderId || !itemId) {
        showMobileAlert("Invalid item selected", "error");
        return;
      }

      const data = Object.fromEntries(new FormData(this).entries());

      try {
        const res = await axios.post(
          `/account/orders/order-details/return-request/${orderId}/${itemId}`,
          data
        );

        if (res.data.success) {
          bootstrap.Modal.getInstance(document.getElementById("returnModal")).hide();
          this.reset();
          showSuccessModal("Return request sent");

          // UI UPDATE
          activeButton.textContent = "Return Requested";
          activeButton.disabled = true;
          activeButton.style.pointerEvents = "none";
        }
      } catch (err) {
        showSuccessModal("Return request failed");
      }
    });

  });
</script>