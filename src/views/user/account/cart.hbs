<link rel="stylesheet" href="/css/user/account/cart.css">

<!-- Slide-in Toast MSG -->
<div id="mobileAlert" class="mobile-alert"></div>

<div class="container py-2">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Your Cart</h2>
  </div>

  {{#if cart.items.length}}
  <div class="row">

    <!-- LEFT: CART ITEMS -->
    <div class="col-lg-8">
      <div class="cart-scroll-area">

        {{#each cart.items}}
        <a class="cart-item-card" href="{{#if this.accessoryId}}
          /all-accessories/view-accessory-product/{{getId this.accessoryId}}
        {{else}}
          /cars-collection/view-car-product/{{getId this.carId}}
        {{/if}}" data-id="{{this._id}}">


          {{!-- IMAGE --}}
          {{#if this.carId}}
          <img src="{{this.variantId.image_url.[0]}}" class="cart-item-img">
          {{else}}
          <img src="{{this.accessoryId.images.[0]}}" class="cart-item-img">
          {{/if}}

          <div class="cart-item-details">

            {{!-- TITLE --}}
            {{#if this.carId}}
            <div class="cart-item-title">{{this.carId.name}} {{#unless (gt this.variantId.stock 0)}}<span
                class="text-danger">(Out of
                Stock)</span>{{/unless}}
            </div>
            <div class="cart-item-meta">Color: {{this.variantId.color}}</div>
            {{else}}
            <div class="cart-item-title">{{this.accessoryId.name}} {{#unless (gt this.accessoryId.stock 0)}}<span
                class="text-danger">(Out of
                Stock)</span>{{/unless}}</div>
            <div class="cart-item-meta">Material: {{this.accessoryId.material}}</div>
            {{/if}}

            {{!-- PRICE --}}
            {{#if this.appliedOffer.isActive}}
            <div class="price-box">
              {{#if this.appliedOffer.isActive}}
              <span class="offer-price">₹ {{formatPrice this.offerPrice}}</span>
              <span class="original-price">₹ {{formatPrice this.price}}</span>
              <span class="discount">
                {{#if (eq this.appliedOffer.discountType "Percentage")}}
                {{this.appliedOffer.discountValue}}% OFF
                {{else}}
                ₹ {{formatPrice this.appliedOffer.discountValue}}
                {{/if}}
              </span>
              {{else}}
              <span class="offer-price">₹ {{formatPrice this.price}}</span>
              {{/if}}
            </div>
            {{else}}
            <div class="price-box">
              <span class="offer-price">₹ {{formatPrice this.price}}</span>
            </div>
            {{/if}}
            <div class="price-box">
              <span class="cart-item-meta">Quantity : </span>
              <span class="cart-item-meta">{{this.quantity}}</span>
            </div>
          </div>

          {{!-- BOTTOM ROW --}}
          <div class="cart-bottom-row">
            {{#if this.accessoryId}}
            <button class="delete-btn remove-acc" data-itemid="{{this._id}}"><i class="bi bi-trash"></i></button>

            <div class="cart-item-meta text-center text-danger" id="errorQuantity" style="display: none;"></div>
            <div class="qty-box" data-item="{{this._id}}">
              <button class="qty-btn minus" data-itemid="{{this._id}}">-</button>
              <span class="qty-value" data-itemid="{{this._id}}" data-qty="{{this.quantity}}">{{this.quantity}}</span>
              <button class="qty-btn plus" data-itemid="{{this._id}}">+</button>
            </div>


            {{else}}
            <button class="delete-btn remove-car" data-itemid="{{this._id}}"><i class="bi bi-trash "></i></button>
            {{/if}}
          </div>

        </a>
        {{/each}}

      </div>
    </div>

    <!-- RIGHT: ORDER SUMMARY -->
    <div class="col-lg-4">
      <div class="order-box">

        <h5 class="fw-bold mb-3">Order Summary</h5>

        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Price ({{cart.items.length}} items)</span>
          <span class="fw-semibold">₹ {{formatPrice cart.totalAmount}}</span>
        </div>

        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Shipping</span>
          <span class="fw-semibold">Free</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <span class="text-muted">Tax <span class="fw-semibold">(GST {{taxRate}}% Only for Accessory)</span></span>
          {{#if cart.accessoryTax}}
          <span class="fw-semibold">₹ {{formatPrice cart.accessoryTax}}</span>
          {{else}}
          <span class="fw-semibold">₹ 0</span>
          {{/if}}
        </div>
        {{#if cart.appliedCoupon.code}}
        <div class="d-flex justify-content-between align-items-center mb-3 bg-light p-2 rounded">
          <span class="text-muted">
            Applied Coupon:
            <strong class="text-dark">{{cart.appliedCoupon.code}}</strong>
          </span>

          <div class="d-flex align-items-center gap-2">
            <span class="fw-semibold text-success">
              - ₹{{formatPrice cart.appliedCoupon.couponDiscount}}
            </span>

            <button class="btn btn-sm btn-outline-danger" id="removeCouponBtn"
              data-couponid="{{cart.appliedCoupon.couponId}}" title="Remove coupon">
              ✕
            </button>
          </div>
        </div>
        {{/if}}


        <hr>

        <div class="d-flex justify-content-between mb-3">
          <h6 class="fw-bold">Total Amount</h6>
          <h6 class="fw-bold">₹ {{formatPrice cart.totalAfterAll}}</h6>
        </div>
        {{#if cart.discountedPrice}}
        <!-- Savings Banner -->
        <div class="alert alert-success d-flex justify-content-between align-items-center py-2 px-3 mb-3" role="alert">
          <span class="fw-semibold text-success">
            Your Total Savings on this order
          </span>
          <span class="fw-semibold text-success">
            ₹ {{formatPrice cart.discountedPrice}}
          </span>
        </div>
        {{/if}}


        <button class="btn btn-orange w-100 mb-3" id="applyCouponBtn">Apply Coupon</button>
        <a href="/cart/checkout-step-1/{{cart._id}}" class="btn btn-black w-100">Proceed to Checkout</a>

        <p class="text-center text-muted small mt-3">
          By proceeding to checkout, you agree to our <br>
          <a href="#" class="text-decoration-none">Terms of Service</a> and
          <a href="#" class="text-decoration-none">Privacy Policy</a>
        </p>

      </div>
    </div>

  </div>

  {{else}}
  <!-- EMPTY CART -->
  <div class="empty-cart-wrapper">
    <div class="empty-cart-box text-center">

      <img src="/images/emptyCart.svg" class="empty-cart-img" alt="Empty Cart">

      <h3 class="empty-cart-title">Your Cart is Empty</h3>
      <p class="empty-cart-text">Looks like you haven't added anything yet.</p>

      <a href="/" class="btn btn-dark continue-btn">Continue Shopping</a>

    </div>
  </div>
  {{/if}}

</div>


{{#if cart}}
<!-- MOBILE BOTTOM BAR -->
<div class="mobile-bottom-bar d-md-none">
  <div class="bottom-total fw-bold fs-5">₹ {{formatPrice cart.totalAmount}}</div>
  <button class="place-order-btn btn btn-dark px-4 py-2 rounded-3">Place Order</button>
</div>
{{/if}}

<!-- Coupon Modal -->
<div class="coupon-modal" id="couponModal">
  <div class="coupon-modal-content">
    <!-- Header -->
    <div class="coupon-modal-header">
      <h5>Available Coupons</h5>
      <button class="close-modal" id="closeModal">
        <i class="bi bi-x"></i>
      </button>
    </div>

    <!-- Body -->
    <div class="coupon-modal-body">

      <!-- Accessory Note -->
      <div class="accessory-note">
        <i class="bi bi-info-circle-fill"></i>
        <div>
          <strong>Note:</strong>
          <p><strong>Coupons are only applicable for accessories</strong></p>
          <p><strong>Only one coupon can be applied per order</strong></p>
        </div>
      </div>


      {{#if coupons.length}}

      <!-- Coupon Items -->
      {{#each coupons}}
      <div class="coupon-item">
        <div class="coupon-left">
          <i class="bi bi-tag-fill coupon-icon"></i>

          <div class="coupon-details">
            <h6 class="coupon-code">{{this.code}}</h6>

            {{#if (eq this.discountType "percentage")}}
            <p class="coupon-discount">
              Get <strong>{{this.discountValue}}%</strong> off
            </p>
            {{else}}
            <p class="coupon-discount">
              Flat <strong>₹{{formatPrice this.discountValue}}</strong> off
            </p>
            {{/if}}

            <p class="coupon-min">
              Min Order: ₹{{formatPrice this.minOrderAmount}}
            </p>

            <p class="coupon-validity">
              Valid till: {{formattedDate this.validTo}}
            </p>
          </div>
        </div>

        <button class="apply-btn" data-coupon="{{this.code}}" data-id="{{this._id}}"
          data-discount="{{this.discountValue}}" data-type="{{this.discountType}}" data-min="{{this.minOrderAmount}}">
          Apply
        </button>
      </div>
      {{/each}}

      {{else}}

      <!-- No coupons -->
      <div class="no-coupons">
        <i class="bi bi-ticket-perforated"></i>
        <p>No coupons available right now</p>
      </div>

      {{/if}}

    </div>

  </div>
</div>

<script src="/js/user/account/cart.js"></script>