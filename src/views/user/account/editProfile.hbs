<link rel="stylesheet" href="/css/user/account/editProfile.css">

<div class="profile-module">
  <div class="edit-card">

    <h2 class="title">Edit Profile</h2>

    <form action="/account/profile/edit-profile" method="POST" enctype="multipart/form-data" class="edit-form">
      <!-- Profile Image -->
      <div class="img-section">
        <div class="img-wrapper">
          <img id="profilePreview" src="{{user.profileImage_url}}" alt="Profile Image">
          <div id="profileImageError"></div>
        </div>

        <label class="img-btn">
          Change Photo
          <input type="file" name="profileImage" id="profileInput" accept="image/*" hidden>
        </label>

        <!-- Delete Button -->
        <button type="button" id="deleteProfileBtn" class="  img-btn--danger btn btn-danger">
          Delete Photo
        </button>

        <!-- Hidden flag for backend -->
        <input type="hidden" name="deleteProfileImage" id="deleteProfileImage" value="false">
      </div>



      <!-- Fields -->
      <div class="grid">

        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" value="{{user.name}}" required>
        </div>

        <div class="form-group">
          <label for="emailInput">Email</label>
          <input id="emailInput" name="email" type="email" required value="{{user.email}}"
            data-original-email="{{user.email}}" autocomplete="email">
          <!-- hidden flag set when verification succeeds -->
          <input type="hidden" id="userId" value="{{user._id}}">
          <input type="hidden" name="email_verified" id="emailVerifiedInput" value="true">
        </div>

        <div class="form-group">
          <label>Phone Number</label>
          <input type="text" name="phone" value="{{user.phoneNumber}}" required>
        </div>

        <div class="form-group">
          <label>Date of Birth</label>
          <input type="date" name="dob" value="{{user.dob}}">
        </div>

      </div>

      <button class="submit-btn" type="submit" id="openConfirm">Save Changes</button>

    </form>

    <!-- Confirmation Modal -->
    <div class="confirm-backdrop" id="confirmModal">
      <div class="confirm-box">
        <h3>Confirm Changes</h3>
        <p>Are you sure you want to update your profile?</p>
        <div class="confirm-actions">
          <button id="cancelBtn" class="cancel-btn">Cancel</button>
          <button id="confirmBtn" class="confirm-btn">Yes, Save</button>
        </div>
      </div>
    </div>


  </div>
</div>

<!-- Hidden field to hold base64 cropped image (server should decode) -->
<input type="hidden" name="croppedImage" id="croppedImageInput" />

<!-- ====== Crop Modal ====== -->
<div class="cropper-backdrop" id="cropperModal" aria-hidden="true">
  <div class="cropper-box" role="dialog" aria-modal="true" aria-labelledby="cropperTitle">
    <header class="cropper-header">
      <h3 id="cropperTitle">Crop Profile Photo</h3>
      <button id="cropClose" class="icon-btn" title="Close">✕</button>
    </header>

    <div class="cropper-body">
      <div class="cropper-stage">
        <img id="cropImage" alt="To be cropped" src="">
      </div>

      <div class="cropper-controls">
        <div class="action-row">
          <button type="button" id="cancelCrop" class="cancel-btn">Cancel</button>
          <button type="button" id="applyCrop" class="confirm-btn">Apply Crop</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OTP Confirmation Modal -->
<div class="otp-backdrop" id="otpModal" aria-hidden="true">
  <div class="otp-box" role="dialog" aria-modal="true" aria-labelledby="otpTitle">
    <header class="otp-header">
      <h3 id="otpTitle">Verify New Email</h3>
      <button id="otpClose" class="icon-btn" aria-label="Close">✕</button>
    </header>

    <div class="otp-body">
      <p class="otp-instruction">We sent a 6-digit code to <strong id="otpTargetEmail"></strong>. Enter it below to
        confirm your new email.</p>

      <form id="otpForm" onsubmit="return false;">
        <div class="otp-inputs" id="otpInputs" role="group" aria-label="Enter OTP">
        </div>

        <div class="otp-row">
          <button type="button" id="verifyOtpBtn" class="confirm-btn">Verify</button>
          <button type="button" id="cancelOtpBtn" class="cancel-btn">Cancel</button>
        </div>

        <div class="otp-meta">
          <button type="button" id="resendBtn" class="text-btn">Resend code</button>
          <span id="resendTimer" class="muted small"></span>
        </div>

        <div id="otpMessage" class="otp-message" aria-live="polite"></div>
      </form>
    </div>
  </div>
</div>

<div id="deletePhotoModal" class="confirm-backdrop">
  <div class="confirm-box">
    <h3>Delete Profile Photo?</h3>
    <p>This action will remove your current profile picture.</p>

    <div class="confirm-actions">
      <button id="cancelDeletePhoto" class="cancel-btn2">Cancel</button>
      <button id="confirmDeletePhoto" class="confirm-btn2">Delete</button>
    </div>
  </div>
</div>

<!-- Custom Swal Loader -->
<div id="customSwal" class="custom-swal-backdrop">
  <div class="custom-swal-box">
    <h3 id="customSwalTitle">Please Wait</h3>
    <p id="customSwalText">Processing...</p>
    <div class="loader"></div>
  </div>
</div>


<script src="/js/user/account/editProfile.js"></script>