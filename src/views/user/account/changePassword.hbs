<style>
  .account-page {
    --bg: #f8f8f8;
    --card: #fff;
    --muted: #9aa0a6;
    --accent: #111;
    --soft: #f1f2f3;
  }

  .account-page body {
    background: var(--bg);
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    margin: 0;
  }

  .account-page .main-card {
    background: var(--card);
    box-shadow: 0 8px 24px rgba(15, 23, 36, 0.06);
    padding: 20px;
    border-radius: 8px;
  }

  .toggle-eye {
    position: absolute;
    right: 12px;
    top: 38px;
    cursor: pointer;
    font-size: 18px;
    color: #666;
  }

  .toggle-eye:hover {
    color: #000;
  }

  /* =======================
        CUSTOM SWAL
     ======================= */
  .custom-swal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    backdrop-filter: blur(3px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
  }

  .custom-swal-backdrop.show {
    display: flex;
  }

  .custom-swal-box {
    width: 330px;
    background: #fff;
    padding: 24px 30px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    animation: popIn 0.25s ease-out;
  }

  .custom-swal-box.error {
    border-top: 6px solid #e74c3c;
  }

  .custom-swal-box.success {
    border-top: 6px solid #2ecc71;
  }

  .custom-swal-box.loading {
    border-top: 6px solid #3498db;
  }

  .custom-swal-btn {
    margin-top: 20px;
    padding: 10px 20px;
    background: #111;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
  }

  .custom-swal-btn:hover {
    background: #000;
  }

  @keyframes popIn {
    from {
      transform: scale(0.85);
      opacity: 0;
    }

    to {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>

<div class="account-page">
  <section id="password" class="main-card mt-4">
    <input type="hidden" id="userId" value="{{user._id}}">

    <h5>Change Password</h5>

    <form id="changePasswordForm" class="mt-3">

      <div class="mb-3 position-relative">
        <label class="form-label">Current Password</label>
        <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password">
        <span class="toggle-eye" data-target="currentPassword">
          <i class="bi bi-eye-slash"></i>
        </span>
      </div>

      <div class="mb-3 position-relative">
        <label class="form-label">New Password</label>
        <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
        <span class="toggle-eye" data-target="newPassword">
          <i class="bi bi-eye-slash"></i>
        </span>
      </div>

      <div class="mb-3 position-relative">
        <label class="form-label">Confirm Password</label>
        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
        <span class="toggle-eye" data-target="confirmPassword">
          <i class="bi bi-eye-slash"></i>
        </span>
      </div>

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-dark">Update Password</button>
      </div>

    </form>
  </section>
</div>

<!-- ==========================
     CUSTOM SWAL POPUP
============================== -->
<div id="customSwalError" class="custom-swal-backdrop">
  <div id="customSwalBox" class="custom-swal-box">
    <h3 id="customSwalTitle">Alert</h3>
    <p id="customSwalText">Message</p>
    <button id="customSwalBtn" class="custom-swal-btn">OK</button>
  </div>
</div>

<script>
  /* =====================================
         FULL CUSTOM SWAL LOGIC
     ===================================== */
  const CustomSwal = {
    timer: null,

    show(title = "Alert", text = "", type = "error", autoClose = 0) {
      const backdrop = document.getElementById("customSwalError");
      const box = document.getElementById("customSwalBox");

      // remove previous types
      box.className = "custom-swal-box";
      box.classList.add(type); // error | success | loading

      document.getElementById("customSwalTitle").textContent = title;
      document.getElementById("customSwalText").textContent = text;

      // Hide OK button for loaders
      document.getElementById("customSwalBtn").style.display =
        type === "loading" ? "none" : "inline-block";

      backdrop.classList.add("show");

      // Auto close
      if (autoClose > 0) {
        if (this.timer) clearTimeout(this.timer);
        this.timer = setTimeout(() => this.hide(), autoClose);
      }
    },

    hide() {
      document.getElementById("customSwalError").classList.remove("show");
      if (this.timer) clearTimeout(this.timer);
    }
  };

  document.getElementById("customSwalBtn").addEventListener("click", () => {
    window.location.reload()
    CustomSwal.hide();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById("changePasswordForm");
    const currentPassword = document.getElementById("currentPassword");
    const newPassword = document.getElementById("newPassword");
    const confirmPassword = document.getElementById("confirmPassword");
    const userId = document.getElementById("userId").value;
    const submitBtn = form.querySelector("button[type='submit']");

    /* -------------------------------
          Create inline error <small>
       ------------------------------- */
    function createMessage(input) {
      const small = document.createElement("small");
      small.style.color = "red";
      small.style.fontSize = "12px";
      small.style.display = "none";
      input.parentNode.appendChild(small);
      return small;
    }

    const msg = {
      current: createMessage(currentPassword),
      new: createMessage(newPassword),
      confirm: createMessage(confirmPassword)
    };

    /* -------------------------------
                Validators
       ------------------------------- */
    function validateCurrent() {
      if (currentPassword.value.trim().length < 3) {
        msg.current.textContent = "Invalid current password.";
        msg.current.style.display = "block";
        return false;
      }
      msg.current.style.display = "none";
      return true;
    }

    function validateNew() {
      if (newPassword.value.trim().length < 6) {
        msg.new.textContent = "Password must be at least 6 characters.";
        msg.new.style.display = "block";
        return false;
      }
      msg.new.style.display = "none";
      return true;
    }

    function validateConfirm() {
      if (confirmPassword.value !== newPassword.value) {
        msg.confirm.textContent = "Passwords do not match.";
        msg.confirm.style.display = "block";
        return false;
      }
      msg.confirm.style.display = "none";
      return true;
    }

    /* -------------------------------
          Live validation (optional)
       ------------------------------- */
    function liveValidate() {
      validateCurrent();
      validateNew();
      validateConfirm();
    }

    currentPassword.addEventListener("input", liveValidate);
    newPassword.addEventListener("input", liveValidate);
    confirmPassword.addEventListener("input", liveValidate);

    /* -------------------------------
                  Submit
       ------------------------------- */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const validCurrent = validateCurrent();
      const validNew = validateNew();
      const validConfirm = validateConfirm();

      // Show all errors together if invalid
      if (!validCurrent || !validNew || !validConfirm) {
        validateCurrent();
        validateNew();
        validateConfirm();
        return;
      }

      // Proceed if valid
      submitBtn.textContent = "Updating...";
      CustomSwal.show("Updating Password", "Please wait...", "loading");

      try {
        const res = await axios.post(`/account/change-password/${userId}`, {
          currentPassword: currentPassword.value,
          newPassword: newPassword.value
        });

        if (res.data.success) {
          CustomSwal.show("Success!", "Password updated successfully!", "success");
        }
        else {
          CustomSwal.show("Error!", `${res.data.alert}`, "error");
        }


        form.reset();
        liveValidate();

      } catch (err) {
        const message = err.response?.data?.alert || "Failed to update password";
        CustomSwal.show("Error!", message, "error");
      }
    });

    /* -------------------------------
               Eye toggle
       ------------------------------- */
    document.querySelectorAll(".toggle-eye").forEach((eye) => {
      eye.addEventListener("click", () => {
        const input = document.getElementById(eye.dataset.target);

        if (input.type === "password") {
          input.type = "text";
          eye.innerHTML = '<i class="bi bi-eye"></i>';
        } else {
          input.type = "password";
          eye.innerHTML = '<i class="bi bi-eye-slash"></i>';
        }
      });
    });

  });
</script>