<style>
  .main-card {
    background: var(--card);
    padding: 20px;
    border-radius: 8px;
  }

  .order-card {
    background: transparent;
    padding: 0;
    border-radius: 6px;
  }

  .order-row {
    background: #fbfbfb;
    padding: 16px;
    border-radius: 6px;
    margin-bottom: 16px;
    border: 1px solid #eee;
  }

  .status-pill {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
  }

  .status-delivered {
    background: #e8fbef;
    color: #0a8a3d;
  }

  .status-processing {
    background: #fff7df;
    color: #b78600;
  }

  .order-row-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .order-meta {
    display: flex;
    gap: 20px;
    align-items: center;
  }

  .order-total {
    text-align: right;
    min-width: 120px;
  }

  .order-status {
    min-width: 140px;
    text-align: right;
  }

  .order-items {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 12px;
  }

  .order-item-image {
    width: 240px;
    height: 100px;
    object-fit: cover;
    border-radius: 6px;
  }

  .order-actions {
    display: flex;
    gap: 8px;
  }

  .order-actions .btn {
    white-space: nowrap;
  }

  @media(max-width:575px) {
    .order-row {
      padding: 12px;
      font-size: 14px;
    }

    .order-row-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .order-items {
      flex-direction: column;
      gap: 12px;
    }

    .order-item-image {
      width: 100%;
      height: 180px;
    }

    .order-actions .btn {
      width: 100%;
      display: block;
    }

    .order-total,
    .order-status {
      align-self: flex-start;
    }
  }
</style>

<section id="orders" class="main-card">
  <h5>Order History</h5>


  <!-- {{!-- TOP ROW --}}
  <div class="order-row-header">
      <div class="order-meta">

        <div>

          <div style="font-size:13px;color:var(--muted)">Order ID</div>
          <div style="font-weight:700">{{this.orderId}}</div>
        </div>

        <div>
          <div style="font-size:13px;color:var(--muted)">Date</div>
          <div>{{formattedDate this.createdAt}}</div>
        </div>
      </div>

      <div class="order-total">
        <div style="font-size:13px;color:var(--muted)">Total</div>
        <div style="font-weight:700">â‚¹ {{formatPrice this.totalAmount}}</div>
      </div>

      <div class="order-status">
        <div style="font-size:13px;color:var(--muted)">Status</div>
        <div class="status-pill status-delivered">{{this.orderStatus}}</div>
      </div>
    </div> -->

  {{!-- LOOP ALL ORDERS --}}

  {{#each orders}}
  {{#each this.items}}

  <div class="order-row mt-3">
    <div class="order-items d-flex justify-content-between align-items-start">

      <!-- LEFT: IMAGE + DETAILS -->
      <div class="d-flex align-items-start gap-3">

        {{#if this.carId}}
        <img class="order-item-image" src="{{this.variantId.image_url.[0]}}" alt="car">
        {{else}}
        <img class="order-item-image" src="{{this.accessoryId.images.[0]}}" alt="accessory">
        {{/if}}

        <div class="flex-grow-1">
          <div class="fw-semibold">
            {{#if this.carId}}
            {{this.carId.name}}
            {{else}}
            {{this.accessoryId.name}}
            {{/if}}
          </div>

          <div class="text-muted mt-1" style="font-size:13px;">
            {{#if this.carId}}
            Color: {{this.variantId.color}}<br>
            {{else}}
            Material : {{this.accessoryId.material}}<br>
            {{/if}}
            Quantity: {{this.quantity}}
          </div>
        </div>
      </div>

      <!-- RIGHT: ACTIONS -->
      <div class="order-actions text-end">
        <a href="/account/orders/order-details/{{../_id}}/{{this._id}}" class="btn btn-outline-dark btn-sm mb-1">
          View Details
        </a>

        {{#if (eqTwo this.orderStatus "return")}}
        <button id="changingButtonReturn" class="btn btn-warning btn-sm returnBtn" data-orderid="{{../_id}}"
          data-itemid="{{this._id}}" data-bs-toggle="modal" data-bs-target="#returnModal">
          <i class="bi bi-bag-plus"></i> Return
        </button>
        {{else}}
        <button id="changingButton" class="btn btn-danger btn-sm cancelBtn" data-orderid="{{../_id}}"
          data-itemid="{{this._id}}" data-bs-toggle="modal" data-bs-target="#cancelModal">
          Cancel Order
        </button>
        {{/if}}
      </div>

    </div>
  </div>

  {{/each}}
  {{/each}}


</section>

<div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5>Product Return</h5>

        <form id="returnForm" class="mt-3">
          <input type="hidden" name="request" value="return">

          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input class="form-control" name="subject" placeholder="subject">
            <small class="text-danger error-subject d-none">Subject is required</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea class="form-control" rows="6" name="message"></textarea>
            <small class="text-danger error-message d-none">Message is required</small>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-dark">
              <i class="bi bi-send"></i> Request
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- cancel order -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h5>Product Cancel</h5>

        <form id="cancelForm" class="mt-3">
          <input type="hidden" name="request" value="cancel">

          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input class="form-control" name="subject">
            <small class="text-danger error-subject d-none">Subject is required</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea class="form-control" rows="6" name="message"></textarea>
            <small class="text-danger error-message d-none">Message is required</small>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-dark">
              <i class="bi bi-send"></i> Request
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>


<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content text-center p-3">
      <h5 class="mb-2">Request Sent</h5>
      <p class="text-muted mb-2" id="responsMsg"></p>
      <i class="bi bi-check-circle-fill text-success" style="font-size:32px;"></i>
    </div>
  </div>
</div>

<script>
  let orderId = null;
  let itemId = null;

  document.addEventListener("DOMContentLoaded", () => {

    // ========== SET IDS WHEN BUTTON CLICKED ==========
    document.querySelectorAll(".cancelBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        orderId = btn.dataset.orderid;
        itemId = btn.dataset.itemid;
      });
    });

    document.querySelectorAll(".returnBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        orderId = btn.dataset.orderid;
        itemId = btn.dataset.itemid;
      });
    });


    // ========== VALIDATION ==========
    function validateForm(form) {
      let valid = true;

      const subject = form.querySelector('input[name="subject"]');
      const message = form.querySelector('textarea[name="message"]');

      const subjectError = form.querySelector(".error-subject");
      const messageError = form.querySelector(".error-message");

      if (!subject.value.trim()) {
        subject.classList.add("is-invalid");
        subjectError.classList.remove("d-none");
        valid = false;
      } else {
        subject.classList.remove("is-invalid");
        subjectError.classList.add("d-none");
      }

      if (!message.value.trim()) {
        message.classList.add("is-invalid");
        messageError.classList.remove("d-none");
        valid = false;
      } else {
        message.classList.remove("is-invalid");
        messageError.classList.add("d-none");
      }

      return valid;
    }

    const responsMsg = document.getElementById("responsMsg")
    const changingButton = document.getElementById("changingButton")
    const changingButtonReturn = document.getElementById("changingButton")
    // ========== SHOW SUCCESS MODAL ==========
    function showSuccessModal(msg = "Processing") {
      const successModal = new bootstrap.Modal(document.getElementById("successModal"));
      responsMsg.textContent = msg
      successModal.show();

      setTimeout(() => {
        successModal.hide();
      }, 2000); // auto-close in 2 sec
    }


    // ========== CANCEL FORM SUBMIT ==========
    document.getElementById("cancelForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!validateForm(this)) return;

      const data = Object.fromEntries(new FormData(this).entries());
      try {
        const res = await axios.post(`/account/orders/order-details/cancel-request/${orderId}/${itemId}`, data)
        if (res.data.success) {
          bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
          this.reset();
          showSuccessModal("We received your request");
          /* ---------- SUCCESS UI UPDATE ---------- */
          changingButton.innerHTML = "Canceled";
          changingButton.classList.remove("btn-warning");
          changingButton.classList.add("btn-secondary");

          // Disable button
          changingButton.disabled = true;

          // Remove modal-related attributes
          changingButton.removeAttribute("data-bs-toggle");
          changingButton.removeAttribute("data-bs-target");
          changingButton.removeAttribute("data-orderid");
          changingButton.removeAttribute("data-itemid");

          // Optional: prevent any click events
          changingButton.style.pointerEvents = "none";

          // Close modal manually
          const modalEl = document.getElementById("returnModal");
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          modalInstance.hide();

        }
        else {
          bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
          this.reset();
          const msg = res.data.alert || "Somthing went wrong"
          showSuccessModal(msg);
        }
      } catch (error) {
        console.log("Error from cencel order", error)
        bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
        this.reset();
        const msg = error.response?.data.alert || "Somthing went wrong"
        showSuccessModal(msg);
      }

    });


    // ========== RETURN FORM SUBMIT ==========
    document.getElementById("returnForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!validateForm(this)) return;

      const data = Object.fromEntries(new FormData(this).entries());

      try {
        const res = await axios.post(`/account/orders/order-details/return-request/${orderId}/${itemId}`, data)
        if (res.data.success) {
          bootstrap.Modal.getInstance(document.getElementById("returnModal")).hide();
          this.reset();
          showSuccessModal("We received your request");
        }
        else {
          bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
          this.reset();
          const msg = res.data.alert || "Somthing went wrong"
          showSuccessModal(msg);
          /* ---------- SUCCESS UI UPDATE ---------- */
          changingButtonReturn.innerHTML = "Return requested";
          changingButtonReturn.classList.remove("btn-warning");
          changingButtonReturn.classList.add("btn-secondary");

          // Disable button
          changingButtonReturn.disabled = true;

          // Remove modal-related attributes
          changingButtonReturn.removeAttribute("data-bs-toggle");
          changingButtonReturn.removeAttribute("data-bs-target");
          changingButtonReturn.removeAttribute("data-orderid");
          changingButtonReturn.removeAttribute("data-itemid");

          // Optional: prevent any click events
          changingButtonReturn.style.pointerEvents = "none";

          // Close modal manually
          const modalEl = document.getElementById("returnModal");
          const modalInstance = bootstrap.Modal.getInstance(modalEl);
          modalInstance.hide();
        }
      } catch (error) {
        console.log("Error from return order", error)
        bootstrap.Modal.getInstance(document.getElementById("cancelModal")).hide();
        this.reset();
        const msg = error.response?.data.alert || "Somthing went wrong"
        showSuccessModal(msg);
      }
    });


  });
</script>