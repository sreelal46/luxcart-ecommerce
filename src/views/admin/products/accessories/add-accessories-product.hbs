<div class="container py-4">
  <h3 class="fw-bold mb-4">Add Accessory Product</h3>

  <form id="accessoryForm" enctype="multipart/form-data">
    <!-- Basic Info -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-light fw-semibold">Basic Information</div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" name="name" placeholder="Enter product name" required />
        </div>

        <div class="col-md-4">
          <label class="form-label">Category</label>
          <select class="form-select" name="category_id" required>
            <option selected disabled>Select category</option>
            {{#each category}}
            <option value="{{this._id}}">{{this.name}}</option>
            {{/each}}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Product Type</label>
          <select class="form-select" name="product_type_id" required>
            <option selected disabled>Select type</option>
            {{#each types}}
            <option value="{{this._id}}">{{this.name}}</option>
            {{/each}}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Brand</label>
          <select class="form-select" name="brand_id" required>
            <option selected disabled>Select brand</option>
            {{#each brands}}
            <option value="{{this._id}}">{{this.name}}</option>
            {{/each}}
          </select>
        </div>

        <div class="col-md-12">
          <label class="form-label">Description</label>
          <textarea class="form-control" rows="3" name="description" placeholder="Enter description"></textarea>
        </div>
      </div>
    </div>

    <!-- Specification -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-light fw-semibold">Specification</div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label">Country of Origin</label>
          <input type="text" class="form-control" name="country_of_origin" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Fabric</label>
          <input type="text" class="form-control" name="fabric" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Finish</label>
          <input type="text" class="form-control" name="finish" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Fitting</label>
          <input type="text" class="form-control" name="fitting" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Warranty</label>
          <input type="text" class="form-control" name="warranty" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Waterproof</label>
          <select class="form-select" name="waterproof">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Vehicle Compatibility -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-light fw-semibold">Vehicle Compatibility</div>
      <div class="card-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Vehicle</label>
          <input type="text" class="form-control" name="vehicle" />
        </div>
        <div class="col-md-6">
          <label class="form-label">Production Year</label>
          <input type="number" class="form-control" name="production_year" />
        </div>
      </div>
    </div>

    <!-- Variants -->
    <div id="variantContainer">
      <div class="variant-section card mb-4 shadow-sm" data-variant-index="1">
        <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
          <span>Main Part</span>
          <button type="button" class="btn btn-sm btn-danger remove-variant d-none">Remove</button>
        </div>

        <div class="card-body row g-3">
          <div class="col-md-4">
            <label class="form-label">Price</label>
            <input type="number" class="form-control" name="price" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Material</label>
            <input type="text" class="form-control" name="material" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Stock</label>
            <input type="number" class="form-control" name="stock" />
          </div>

          <div class="col-12">
            <label class="form-label h5 fw-bold">Images</label>
            <div class="variant-images-container d-flex flex-wrap gap-3">
              <div class="upload-card add-image-btn d-flex flex-column justify-content-center align-items-center">
                <i class="bi bi-plus-circle fs-3"></i>
                <span class="small text-muted mt-1">Add Image</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4">Save Product</button>
    </div>
  </form>
</div>

<!-- Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen-lg-down modal-xl modal-dialog-centered">
    <div class="modal-content" style="height: 90vh; border-radius: 12px; overflow: hidden;">
      <div class="modal-header border-0 py-3 px-4"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title text-white fw-semibold">
          <i class="bi bi-crop me-2"></i>Crop Image
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4" style="height: calc(100% - 140px); overflow: hidden; background-color: #f8f9fa;">
        <div
          style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <img id="cropImage" style="max-width: 100%; max-height: 100%; display: block;" />
        </div>
      </div>
      <div class="modal-footer border-0 py-3 px-4" style="height: 70px; background-color: #fff;">
        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
        <button type="button" id="cropConfirm" class="btn btn-primary px-4"
          style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
          <i class="bi bi-check-circle me-2"></i>Crop & Save
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    let cropper = null;
    let currentInput = null;
    const cropModalEl = document.getElementById("cropModal");
    const cropModal = bootstrap.Modal.getOrCreateInstance(cropModalEl);
    let variantCount = 1;

    // Add image upload box
    function addImageBox(variantSection, variantIndex) {
      const imageContainer = variantSection.querySelector(".variant-images-container");
      const uploadBox = document.createElement("div");
      uploadBox.classList.add(
        "upload-box",
        "d-flex",
        "flex-column",
        "justify-content-center",
        "align-items-center",
        "border",
        "rounded",
        "mt-3",
        "p-4",
        "position-relative"
      );
      uploadBox.style.width = "300px";
      uploadBox.style.height = "250px";
      uploadBox.style.cursor = "pointer";
      uploadBox.style.textAlign = "center";
      uploadBox.style.transition = "0.3s";
      uploadBox.style.background = "#f8f9fa";

      uploadBox.innerHTML = `
      <i class="bi bi-cloud-arrow-up fs-1 text-secondary"></i>
      <p class="mt-2 mb-1 fw-semibold text-muted">Click to upload image</p>
      <small class="text-muted">PNG, JPG, JPEG (max 5MB)</small>
      <input type="file" name="variant_images_${variantIndex}[]" hidden accept="image/*" />
      <div class="image-preview mt-3"></div>
      <button type="button" class="btn btn-sm btn-outline-danger remove-image-btn position-absolute top-0 end-0 m-1 rounded-circle">
        <i class="bi bi-x-lg"></i>
      </button>
    `;

      uploadBox.addEventListener("mouseenter", () => {
        uploadBox.style.background = "#e9ecef";
      });
      uploadBox.addEventListener("mouseleave", () => {
        uploadBox.style.background = "#f8f9fa";
      });

      imageContainer.appendChild(uploadBox);

      uploadBox.addEventListener("click", (e) => {
        if (e.target.closest(".remove-image-btn")) return;
        uploadBox.querySelector("input").click();
      });

      uploadBox.querySelector(".remove-image-btn").addEventListener("click", () => {
        uploadBox.remove();
      });
    }

    // Bind static "Add Image" to create real upload boxes
    function bindStaticAddImageButtons() {
      document.querySelectorAll('.upload-card.add-image-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const variantSection = btn.closest(".variant-section");
          const variantIndex = parseInt(variantSection.getAttribute("data-variant-index")) || 1;
          addImageBox(variantSection, variantIndex);
        });
      });
    }

    bindStaticAddImageButtons();

    // Handle file input and cropping workflow
    document.addEventListener("change", (e) => {
      if (e.target.matches("input[type='file'][name^='variant_images']")) {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.type.match("image.*")) {
          alert("Please select an image file");
          e.target.value = null;
          return;
        }
        currentInput = e.target;
        const img = document.getElementById("cropImage");
        const reader = new FileReader();
        reader.onload = (event) => {
          img.src = event.target.result;
          cropModal.show();
        };
        reader.readAsDataURL(file);
      }
    });

    // Initialize Cropper when modal shows
    cropModalEl.addEventListener("shown.bs.modal", () => {
      if (!cropper && currentInput) {
        const img = document.getElementById("cropImage");
        cropper = new Cropper(img, {
          viewMode: 2,
          autoCropArea: 0.95,
          responsive: true,
          background: false,
          zoomable: true,
          cropBoxResizable: true,
        });
      }
    });

    // Confirm cropping and replace file input with cropped image
    document.getElementById("cropConfirm").addEventListener("click", () => {
      if (!cropper || !currentInput) return;
      const btn = document.getElementById("cropConfirm");
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

      setTimeout(() => {
        try {
          const canvas = cropper.getCroppedCanvas({ maxWidth: 4096, maxHeight: 4096 });
          canvas.toBlob((blob) => {
            const newFile = new File([blob], currentInput.files[0].name, {
              type: "image/jpeg",
              lastModified: Date.now(),
            });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(newFile);
            currentInput.files = dataTransfer.files;

            // Preview
            const previewContainer = currentInput.closest(".upload-box")?.querySelector(".image-preview");
            if (previewContainer) {
              previewContainer.innerHTML = "";
              const imgPreview = document.createElement("img");
              imgPreview.src = URL.createObjectURL(newFile);
              imgPreview.style.width = "100%";
              imgPreview.style.borderRadius = "8px";
              previewContainer.appendChild(imgPreview);
            }

            if (cropper) {
              cropper.destroy();
              cropper = null;
            }
            currentInput = null;
            cropModal.hide();

            // SAFETY: Remove stuck modal backdrop if needed
            setTimeout(() => {
              document.body.classList.remove('modal-open');
              document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            }, 150); // after modal animation finishes
          }, "image/jpeg", 0.95);
        } catch (err) {
          cropModal.hide();
          document.body.classList.remove('modal-open');
          document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
          console.error(err);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }, 100);
    });

    // Cleanup cropper on modal hide
    cropModalEl.addEventListener("hidden.bs.modal", () => {
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      currentInput = null;
      // Remove stuck backdrop if any
      setTimeout(() => {
        document.body.classList.remove('modal-open');
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
      }, 150);
    });

    // Remove variant buttons functionality
    document.querySelectorAll(".remove-variant").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        btn.closest(".variant-section").remove();
      });
    });

    // Form submit
    const accessoryForm = document.getElementById("accessoryForm");
    accessoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(accessoryForm);

      try {
        Swal.fire({
          title: "Saving Accessory...",
          html: "Please wait",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        const res = await axios.post("/admin/products-management/add-accessories-product", formData, {
          headers: { "Content-Type": "multipart/form-data" },
        });

        Swal.close();

        if (res.data.success) {
          Swal.fire({
            icon: "success",
            title: "Accessory Added Successfully",
            timer: 1500,
            showConfirmButton: false,
          }).then(() => {
            window.location.href = res.data.redirect;
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed to Add Accessory",
            text: res.data.message || "Something went wrong!",
          });
        }
      } catch (error) {
        Swal.close();
        Swal.fire({
          icon: "error",
          title: "Error",
          text: error.response?.data?.message || "Server error occurred",
        });
      }
    });
  });
</script>