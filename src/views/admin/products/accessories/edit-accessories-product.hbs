<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <h2 class="fw-bold mb-4 text-center">Edit Accessory Product</h2>

      <!-- Image Gallery -->
      <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-light fw-semibold fs-5">Images</div>
        <div class="card-body">
          <div id="image-gallery" class="d-flex flex-wrap gap-3">
            {{#each accessory.images}}
            <div class="image-box shadow-sm rounded overflow-hidden position-relative" data-src="{{this}}">
              <img src="{{this}}" alt="{{../accessory.name}}" class="img-fluid"
                style="width: 180px; height: 120px; object-fit: cover;" />
              <button type="button" class="remove-image-btn">&times;</button>
            </div>
            {{/each}}
            <div class="add-image-btn"
              style="width: 180px; height: 120px; border-radius: 12px; cursor: pointer; border: 1px dashed #6c757d; display: flex; justify-content: center; align-items: center;">
              + Add Image
            </div>
          </div>
        </div>
      </div>

      <!-- Basic Info -->
      <form id="editAccessoryForm" method="POST" enctype="multipart/form-data">
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header bg-light fw-semibold fs-5">Basic Information</div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <input type="hidden" value="{{accessory._id}}" id="accessoryId" name="accessoryId">
              <label for="name" class="form-label mb-1"><strong>Name:</strong></label>
              <input type="text" id="name" name="name" class="form-control" value="{{accessory.name}}" required />
            </li>
            <li class="list-group-item">
              <label for="price" class="form-label mb-1"><strong>Price:</strong></label>
              <input type="number" id="price" name="price" class="form-control" value="{{accessory.price}}" required />
            </li>
            <li class="list-group-item">
              <label for="material" class="form-label mb-1"><strong>Material:</strong></label>
              <input type="text" id="material" name="material" class="form-control" value="{{accessory.material}}" />
            </li>
            <li class="list-group-item">
              <label for="stock" class="form-label mb-1"><strong>Stock:</strong></label>
              <input type="number" id="stock" name="stock" class="form-control" value="{{accessory.stock}}" />
            </li>
            <li class="list-group-item">
              <label for="category" class="form-label mb-1"><strong>Category:</strong></label>
              <select id="category" name="category_id" class="form-select">
                {{#each categories}}
                <option value="{{this._id}}" {{#if (eq this._id ../accessory.category_id._id)}}selected{{/if}}>
                  {{this.name}}
                </option>
                {{/each}}
              </select>
            </li>
            <li class="list-group-item">
              <label for="product_type" class="form-label mb-1"><strong>Product Type:</strong></label>
              <select id="product_type" name="product_type_id" class="form-select">
                {{#each types}}
                <option value="{{this._id}}" {{#if (eq this._id ../accessory.product_type_id._id)}}selected{{/if}}>
                  {{this.name}}
                </option>
                {{/each}}
              </select>
            </li>
            <li class="list-group-item">
              <label for="brand" class="form-label mb-1"><strong>Brand:</strong></label>
              <select id="brand" name="brand_id" class="form-select">
                {{#each brands}}
                <option value="{{this._id}}" {{#if (eq this._id ../accessory.brand_id._id)}}selected{{/if}}>
                  {{this.name}}
                </option>
                {{/each}}
              </select>
            </li>
            <li class="list-group-item">
              <label for="description" class="form-label mb-1"><strong>Description:</strong></label>
              <textarea id="description" name="description" class="form-control"
                rows="3">{{accessory.description}}</textarea>
            </li>
          </ul>
        </div>

        <!-- Specification -->
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header bg-light fw-semibold fs-5">Specifications</div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <label for="country_of_origin" class="form-label mb-1"><strong>Country of Origin:</strong></label>
              <input type="text" id="country_of_origin" name="country_of_origin" class="form-control"
                value="{{accessory.country_of_origin}}" />
            </li>
            <li class="list-group-item">
              <label for="fabric" class="form-label mb-1"><strong>Fabric:</strong></label>
              <input type="text" id="fabric" name="fabric" class="form-control" value="{{accessory.fabric}}" />
            </li>
            <li class="list-group-item">
              <label for="finish" class="form-label mb-1"><strong>Finish:</strong></label>
              <input type="text" id="finish" name="finish" class="form-control" value="{{accessory.finish}}" />
            </li>
            <li class="list-group-item">
              <label for="fitting" class="form-label mb-1"><strong>Fitting:</strong></label>
              <input type="text" id="fitting" name="fitting" class="form-control" value="{{accessory.fitting}}" />
            </li>
            <li class="list-group-item">
              <label for="warranty" class="form-label mb-1"><strong>Warranty:</strong></label>
              <input type="text" id="warranty" name="warranty" class="form-control" value="{{accessory.warranty}}" />
            </li>
            <li class="list-group-item">
              <strong>Waterproof:</strong>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" id="waterproof" name="waterproof" {{#if
                  accessory.waterproof}}checked{{/if}} />
                <label class="form-check-label" for="waterproof">Yes</label>
              </div>
            </li>
          </ul>
        </div>

        <!-- Vehicle Compatibility -->
        <div class="card shadow-sm mb-4 border-0">
          <div class="card-header bg-light fw-semibold fs-5">Vehicle Compatibility</div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <label for="vehicle" class="form-label mb-1"><strong>Vehicle:</strong></label>
              <input type="text" id="vehicle" name="vehicle" class="form-control" value="{{accessory.vehicle}}" />
            </li>
            <li class="list-group-item">
              <label for="production_year" class="form-label mb-1"><strong>Production Year:</strong></label>
              <input type="text" id="production_year" name="production_year" class="form-control"
                value="{{accessory.production_year}}" />
            </li>
          </ul>
        </div>

        <!-- Submit Button -->
        <div class="d-flex justify-content-end gap-3 mt-4">
          <a href="/admin/products-management" class="btn btn-outline-secondary px-4">
            <i class="bi bi-arrow-left-circle me-1"></i> Cancel
          </a>
          <button type="submit" class="btn btn-primary px-4">
            <i class="bi bi-check-circle me-1"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Crop Modal -->
<div class="modal" id="cropperModal"
  style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
  <div class="modal-content" style="background:#fff; padding:15px; border-radius:10px; max-width:600px; width:90%;">
    <h5>Crop Image</h5>
    <div style="width:100%; max-height:400px;">
      <img id="cropperImage" style="max-width:100%; display:block; margin:auto;">
    </div>
    <div class="mt-2 text-end">
      <button id="cropCancel" class="btn btn-secondary">Cancel</button>
      <button id="cropSave" class="btn btn-primary">Crop & Save</button>
    </div>
  </div>
</div>

<style>
  .image-box:hover img {
    transform: scale(1.05);
    transition: 0.3s ease;
  }

  .card-header {
    border-bottom: 1px solid #e9ecef;
  }

  .image-box {
    width: 180px;
    height: 120px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #f8f9fa;
    position: relative;
    display: inline-block;
  }

  .image-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .image-box:hover img {
    transform: scale(1.05);
  }

  .remove-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.8);
    border: none;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    line-height: 22px;
    cursor: pointer;
    z-index: 10;
  }

  .add-image-btn {
    width: 180px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px dashed #6c757d;
    border-radius: 12px;
    cursor: pointer;
  }
</style>

<!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" /> -->

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const imageGallery = document.getElementById("image-gallery");
    const cropperModal = document.getElementById("cropperModal");
    const cropperImage = document.getElementById("cropperImage");
    const cropCancelBtn = document.getElementById("cropCancel");
    const cropSaveBtn = document.getElementById("cropSave");
    const editAccessoryForm = document.getElementById("editAccessoryForm");
    const accessoryId = document.getElementById("accessoryId").value;

    let cropper;
    let currentInput;
    let removedImages = [];

    // Remove image button - track removed images and remove preview
    imageGallery.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-image-btn")) {
        const imageBox = e.target.closest(".image-box");
        if (imageBox.dataset.src) {
          removedImages.push(imageBox.dataset.src);
        }
        imageBox.remove();
      }
    });

    // Add image button - open file picker and initialize cropper
    imageGallery.querySelector(".add-image-btn").addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.name = "images"; // ADD this so multer can detect files
      input.style.display = "none";
      document.body.appendChild(input);
      currentInput = input;

      input.addEventListener("change", () => {
        if (input.files.length) {
          const reader = new FileReader();
          reader.onload = (event) => {
            cropperImage.src = event.target.result;
            cropperModal.style.display = "flex";

            // Free manual cropping
            cropper = new Cropper(cropperImage, {
              aspectRatio: NaN,           // Free cropping
              viewMode: 1,
              movable: true,
              zoomable: true,
              cropBoxResizable: true,
              cropBoxMovable: true,
              responsive: true,
              background: true,
            });
          };
          reader.readAsDataURL(input.files[0]);
        }
      });

      input.click();
    });

    // Cancel cropping - clean up
    cropCancelBtn.addEventListener("click", () => {
      if (cropper) cropper.destroy();
      cropperModal.style.display = "none";

      if (currentInput) {
        currentInput.value = "";
        currentInput.remove();
        currentInput = null;
      }
    });

    // Save cropped image - add new image preview and input inside form
    cropSaveBtn.addEventListener("click", () => {
      if (!cropper) return;
      const canvas = cropper.getCroppedCanvas({ width: 320, height: 180 });
      canvas.toBlob((blob) => {
        const fileName = `cropped-accessory-${Date.now()}.jpg`;
        const croppedFile = new File([blob], fileName, { type: "image/jpeg" });

        // Add the cropped file to the currentInput
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(croppedFile);
        currentInput.files = dataTransfer.files;

        // Append file input inside the form to include on submission
        const form = document.getElementById("editAccessoryForm");
        form.appendChild(currentInput);

        // Create image box preview
        const imageBox = document.createElement("div");
        imageBox.classList.add("image-box", "shadow-sm", "rounded", "overflow-hidden", "position-relative");

        const img = document.createElement("img");
        img.src = URL.createObjectURL(croppedFile);
        imageBox.appendChild(img);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-image-btn";
        removeBtn.innerHTML = "&times;";
        imageBox.appendChild(removeBtn);

        // Insert new image box before add button
        imageGallery.insertBefore(imageBox, imageGallery.querySelector(".add-image-btn"));

        cropper.destroy();
        cropperModal.style.display = "none";
        currentInput = null;
      }, "image/jpeg");
    });

    // Submit form - append removed images JSON string
    editAccessoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(editAccessoryForm);
      formData.append("removed_images", JSON.stringify(removedImages));

      try {
        Swal.fire({
          title: "Saving Accessory...",
          html: "Please wait",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        const res = await axios.put(`/admin/products-management/edit-accessories-product/${accessoryId}`, formData, {
          headers: { "Content-Type": "multipart/form-data" },
        });
        Swal.close();
        if (res.data.success) {
          Swal.fire({
            title: "Product Updated Successfully!",
            text: "Your Accessory product details have been updated.",
            icon: "success",
            confirmButtonText: "OK",
            confirmButtonColor: "#3085d6",
          }).then(() => {
            window.location.href = res.data.redirect;
          });
        } else {
          Swal.fire({
            title: "Update Failed",
            text: res.data.message || "Something went wrong while updating the product.",
            icon: "error",
            confirmButtonText: "Try Again",
          });
        }
      } catch (error) {
        if (error.response) {
          Swal.close();
          console.error("Backend responded with error:", error.response.data);
          Swal.fire({
            title: "Server Error",
            text: error.response.data.message || "Something went wrong on the server.",
            icon: "error",
            confirmButtonText: "OK",
          });
        } else if (error.request) {
          console.error("No response from backend:", error.request);
          Swal.fire({
            title: "No Response",
            text: "The server did not respond. Please try again later.",
            icon: "warning",
            confirmButtonText: "OK",
          });
        } else {
          console.error("Request error:", error.message);
          Swal.fire({
            title: "Request Error",
            text: "An unexpected error occurred.",
            icon: "error",
            confirmButtonText: "OK",
          });
        }
      }
    });
  });
</script>