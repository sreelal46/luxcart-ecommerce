<div class="bg-light min-vh-100 d-flex align-items-center justify-content-center py-5">
  <div class="bg-white rounded-3 shadow p-5" style="max-width: 500px; width: 100%;">
    <div class="text-center mb-4">
      <a class="h2 fw-medium text-dark text-decoration-none">{{alert}}</a>
      <a href="/" class="h2 fw-bold text-dark text-decoration-none">LuxCart</a>
      <h1 class="h5 fw-bold mt-3 mb-2">Enter Verification Code</h1>
      <p class="text-muted small mb-0">We’ve sent a 6-digit code to your email</p>
    </div>

    <!-- Alert -->
    <div id="serverMessage" class="alert d-none text-center"></div>

    <form method="post" id="OTPVerificationForm" class="mt-4">
      <div class="mb-4 text-center">
        <div class="d-flex justify-content-center gap-2">
          <input type="text" maxlength="1" class="form-control text-center" name="otp1"
            style="width: 50px; font-size: 20px;">
          <input type="text" maxlength="1" class="form-control text-center" name="otp2"
            style="width: 50px; font-size: 20px;">
          <input type="text" maxlength="1" class="form-control text-center" name="otp3"
            style="width: 50px; font-size: 20px;">
          <input type="text" maxlength="1" class="form-control text-center" name="otp4"
            style="width: 50px; font-size: 20px;">
          <input type="text" maxlength="1" class="form-control text-center" name="otp5"
            style="width: 50px; font-size: 20px;">
          <input type="text" maxlength="1" class="form-control text-center" name="otp6"
            style="width: 50px; font-size: 20px;">
        </div>
      </div>

      <button type="submit" class="btn btn-dark w-100 fw-medium">Verify</button>

      <div class="text-center mt-3">
        <p class="small text-muted mb-0">
          Didn’t receive the code?
          <a href="/admin/resend-otp" id="timer" class="text-dark text-decoration-none fw-medium">Resend</a>
        </p>
      </div>
    </form>
  </div>
</div>

<!-- OTP Validation & Submit -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const otpInputs = document.querySelectorAll('input[name^="otp"]');
    const serverMessage = document.getElementById("serverMessage");
    const OTPVerificationForm = document.getElementById("OTPVerificationForm");

    // Auto-focus first input
    if (otpInputs.length > 0) otpInputs[0].focus();

    otpInputs.forEach((input, index) => {
      // Allow digits only & move to next input
      input.addEventListener("input", () => {
        input.value = input.value.replace(/\D/g, ""); // only digits

        if (input.value && index < otpInputs.length - 1) {
          otpInputs[index + 1].focus();
        }

        // Auto submit if all filled
        const allFilled = Array.from(otpInputs).every(inp => inp.value);
        if (allFilled) OTPVerificationForm.requestSubmit();
      });

      // Backspace → previous input
      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !input.value && index > 0) {
          otpInputs[index - 1].focus();
        }
      });

      // Paste OTP
      input.addEventListener("paste", (e) => {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData)
          .getData("text")
          .trim()
          .replace(/\D/g, "");

        if (!pasteData) return;

        otpInputs.forEach((otpInput, i) => {
          otpInput.value = pasteData[i] || "";
        });

        const nextEmpty = Array.from(otpInputs).find(inp => !inp.value);
        if (nextEmpty) nextEmpty.focus();
        else OTPVerificationForm.requestSubmit();
      });
    });

    // Submit handler
    OTPVerificationForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      serverMessage.classList.add("d-none");
      serverMessage.textContent = "";

      const formData = Object.fromEntries(new FormData(OTPVerificationForm).entries());
      const otp = Object.values(formData).join("");
      const OTPRegex = /^\d{6}$/;

      if (!OTPRegex.test(otp)) {
        serverMessage.className = "alert alert-danger text-center";
        serverMessage.textContent = "Please enter a valid 6-digit numeric OTP";
        serverMessage.classList.remove("d-none");
        return;
      }

      // Show verifying alert
      serverMessage.className = "alert alert-info text-center";
      serverMessage.textContent = "Verifying OTP...";
      serverMessage.classList.remove("d-none");

      try {
        const res = await axios.post("/admin/otp-verify", formData, { withCredentials: true });

        if (res.data.success) {
          serverMessage.className = "alert alert-success text-center";
          serverMessage.textContent = "OTP verified! Redirecting...";
          serverMessage.classList.remove("d-none");
          setTimeout(() => (window.location.href = res.data.redirect), 800);
        } else {
          serverMessage.className = "alert alert-danger text-center";
          serverMessage.textContent = res.data.alert || "Invalid OTP. Please try again.";
          serverMessage.classList.remove("d-none");
        }
      } catch (error) {
        serverMessage.className = "alert alert-danger text-center";
        serverMessage.textContent = error.response?.data?.alert || "Server error. Please try again.";
        serverMessage.classList.remove("d-none");
      }
    });
  });
</script>

<!-- OTP Timer -->
<script src="/common/OTPTimer.js"></script>