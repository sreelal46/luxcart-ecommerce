<style>
  body {
    background: #f8f9fa
  }

  /* Order Status Badges */
  .badge-status {
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 999px;
    text-transform: capitalize;
    letter-spacing: 0.3px;
  }

  /* Individual statuses */
  .badge-placed {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
  }

  .badge-confirmed {
    background-color: #e6f4ea;
    color: #137333;
    border: 1px solid #cce8d5;
  }

  .badge-shipped {
    background-color: #e8f0fe;
    color: #1a73e8;
    border: 1px solid #d2e3fc;
  }

  .badge-out-for-delivery {
    background-color: #ede7f6;
    color: #5e35b1;
    border: 1px solid #d1c4e9;
  }

  .badge-delivered {
    background-color: #e6f4ea;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  .badge-cancelled {
    background-color: #fdecea;
    color: #b02a37;
    border: 1px solid #f5c2c7;
  }

  .badge-returned {
    background-color: #fff0f6;
    color: #a61e4d;
    border: 1px solid #fcc2d7;
  }


  .card {
    border-radius: 14px
  }

  /* STATUS COLORS */
  .status-badge.pending {
    background: #ffc107
  }

  .status-badge.confirmed {
    background: #0d6efd
  }

  .status-badge.shipped {
    background: #6f42c1
  }

  .status-badge.out_for_delivery {
    background: #20c997
  }

  .status-badge.delivered {
    background: #198754
  }

  .status-badge.cancelled {
    background: #dc3545
  }

  .item-status.pending {
    background: #ffe69c
  }

  .item-status.confirmed {
    background: #cfe2ff
  }

  .item-status.shipped {
    background: #e2d9f3
  }

  .item-status.delivered {
    background: #d1e7dd
  }

  .item-status.cancelled {
    background: #f8d7da
  }

  .badge {
    text-transform: capitalize;
    padding: 6px 12px;
    border-radius: 10px;
  }

  /* ORDER ITEM */
  .order-item {
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
    background: #fff;
  }

  .order-item img {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 10px;
    border: 1px solid #eee;
  }

  /* SUMMARY */
  .order-summary .total {
    font-size: 20px;
    font-weight: 700;
    color: #0d6efd;
  }

  /* ===============================
   Slide-in Toast MSG
=============================== */

  .mobile-alert {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #111;
    color: #fff;
    padding: 12px 20px;
    border-radius: 14px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.35s ease;
    box-shadow: 0 6px 22px rgba(0, 0, 0, 0.25);
    z-index: 9999;
  }

  .mobile-alert.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  button {
    padding: 10px 20px;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
  }

  @media (min-width: 768px) {
    .mobile-alert {
      top: 20px;
      bottom: auto;
      transform: translateX(-50%) translateY(-100px);
    }

    .mobile-alert.show {
      transform: translateX(-50%) translateY(0);
    }
  }

  .message-green {
    color: #00ff7f;
  }

  .message-red {
    color: #ff4d4d;
  }

  .message-yellow {
    color: #ffcc00;
  }

  .success-icon,
  .error-icon {
    font-size: 16px;
    /* same size */
    margin-right: 6px;
    /* space */
    vertical-align: middle;
  }

  .success-icon {
    color: #00ff7f;
    /* green */
  }

  .error-icon {
    color: #dc3545;
    /* red */
  }

  .yellow-icon {
    color: #ffcc00;
    /* red */
  }

  .status-action {
    min-width: 150px;
    flex-shrink: 0;
  }
</style>

<div id="mobileAlert" class="mobile-alert"></div>

<div class="container py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold mb-0">
      <i class="bi bi-box-seam me-2"></i>Order Details
    </h3>
    <a href="/admin/orders-management" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </a>
  </div>

  <div class="row g-4">

    <!-- LEFT -->
    <div class="col-lg-8">

      <!-- ORDER + CUSTOMER -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-3">
            <div>
              <h5 class="fw-bold mb-1">Order #{{order.orderId}}</h5>
              <small class="text-muted">
                Placed on {{formattedDate order.createdAt}}
              </small>
            </div>
            <span class="badge status-badge {{order.orderStatus}}">
              {{order.orderStatus}}
            </span>
          </div>

          <hr>

          <div class="row">
            <div class="col-md-6">
              <p class="fw-semibold mb-1">Customer</p>
              <small>{{order.address.name}}</small><br>
              <small>{{order.address.email}}</small><br>
              <small>{{order.address.phone}}</small>
            </div>

            <div class="col-md-6">
              <p class="fw-semibold mb-1">Shipping Address</p>
              <small>
                {{order.address.street}},
                {{order.address.city}},
                {{order.address.state}} - {{order.address.pincode}}
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- ORDER ITEMS -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Order Items</h5>

          {{#each order.items}}
          <div class="order-item">
            <div class="d-flex align-items-center justify-content-between">

              <div class="d-flex align-items-center gap-3">
                <img
                  src="{{#if this.variantId}}{{this.variantId.image_url.[0]}}{{else}}{{this.accessoryId.images.[0]}}{{/if}}"
                  onerror="this.src='/images/placeholder.png'">

                <div>
                  <div class="fw-semibold">
                    {{#if this.carId}}{{this.carId.name}}{{else}}{{this.accessoryId.name}}{{/if}}
                  </div>
                  <small class="text-muted">
                    Qty {{this.quantity}} • ₹ {{formatPrice this.price}}
                  </small>
                </div>
              </div>

              <div class="d-flex align-items-center gap-3">
                <div class="user-item-meta-area">
                  {{#if (eq this.fulfillmentStatus.status "out_for_delivery")}}
                  <span class="badge-status {{orderStatusBadge this.fulfillmentStatus.status}}">
                    Out for Delivery
                  </span>
                  {{else}}
                  <span class="badge item-status {{orderStatusBadge this.fulfillmentStatus.status}}">
                    {{this.fulfillmentStatus.status}}
                  </span>
                  {{/if}}
                </div>

                <div class="status-action">
                  {{#if this.cancel.requested}}
                  {{else if this.return.requested}}
                  {{else}}
                  <select class="form-select form-select-sm item-status-select" data-orderid="{{../order._id}}"
                    data-itemid="{{this._id}}">

                    <option value="placed" {{#ifEquals this.fulfillmentStatus.status "placed" }}selected{{/ifEquals}}>
                      Placed</option>
                    <option value="confirmed" {{#ifEquals this.fulfillmentStatus.status "confirmed"
                      }}selected{{/ifEquals}}>Confirmed</option>
                    <option value="shipped" {{#ifEquals this.fulfillmentStatus.status "shipped" }}selected{{/ifEquals}}>
                      Shipped</option>
                    <option value="out_for_delivery" {{#ifEquals this.fulfillmentStatus.status "out_for_delivery"
                      }}selected{{/ifEquals}}>
                      Out for Delivery
                    </option>
                    <option value="delivered" {{#ifEquals this.fulfillmentStatus.status "delivered"
                      }}selected{{/ifEquals}}>
                      Delivered
                    </option>
                  </select>
                  {{/if}}

                </div>
              </div>

            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="col-lg-4">

      <!-- PAYMENT INFO -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Payment Details</h5>

          <div class="mb-2 d-flex justify-content-between">
            <span>Method</span>
            <strong class="text-capitalize">
              {{order.payment.method}}
            </strong>
          </div>

          <div class="mb-2 d-flex justify-content-between">
            <span>Status</span>
            <span class="badge {{order.payment.status}}">
              {{order.payment.status}}
            </span>
          </div>

          {{#if order.payment.transactionId}}
          <div class="d-flex justify-content-between">
            <span>Transaction ID</span>
            <small class="text-muted">
              {{order.payment.transactionId}}
            </small>
          </div>
          {{/if}}
        </div>
      </div>

      <!-- ORDER STATUS -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Update Order Status</h5>
          <select id="orderStatusSelect" class="form-select" data-orderid="{{order._id}}">
            <option value="placed">Placed</option>
            <option value="confirmed">Confirmed</option>
            <option value="shipped">Shipped</option>
            <option value="out_for_delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
          </select>
        </div>
      </div>

      <!-- <select id="orderStatusSelect" class="form-select fs-6 py-2" data-orderid="{{order._id}}">

      </select> -->
      <!-- SUMMARY -->
      <div class="card shadow-sm order-summary">
        <div class="card-body">
          <h5 class="fw-bold mb-3">Order Summary</h5>

          <div class="d-flex justify-content-between mb-2">
            <span>Advance Paid</span>
            <span>- ₹ {{formatPrice order.advanceAmount}}</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>Remaining</span>
            <span>₹ {{formatPrice order.remainingAmount}}</span>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <span>Tax</span>
            <span>₹ {{formatPrice order.taxAmount}}</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between total">
            <span>Total</span>
            <span>₹ {{formatPrice order.totalAmount}}</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<script>
  function showMobileAlert(msg, type) {
    const alert = document.getElementById("mobileAlert");
    const icon =
      type === "success" ? "check-circle-fill success-icon" :
        "x-circle-fill error-icon";

    alert.innerHTML = `<i class="bi bi-${icon}"></i> ${msg}`;
    alert.classList.add("show");
    setTimeout(() => alert.classList.remove("show"), 2000);
  }

  document.getElementById("orderStatusSelect")
    .addEventListener("change", async e => {
      try {
        const res = await axios.patch(
          `/admin/orders-management/update-status/${e.target.dataset.orderid}`,
          {
            status: e.target.value,
          }
        );
        if (res.data.success) {
          showMobileAlert("Order status updated", "success");
          setTimeout(() => location.reload(), 2000)
        }
        else {
          const msg = res.data?.alert || "Update failed"
          showMobileAlert(msg, "error");
        }

      } catch (error) {
        const msg = error.response?.data?.alert || "INTERNAL SERVER ERROR"
        showMobileAlert(msg, "error");
      }
    });

  document.querySelectorAll(".item-status-select")
    .forEach(select => {
      select.addEventListener("change", async () => {
        try {
          const res = await axios.patch(
            `/admin/orders-management/update-status/${select.dataset.orderid}/${select.dataset.itemid}`,
            {
              status: select.value
            }
          );
          if (res.data.success) {
            showMobileAlert("Item updated", "success");
            setTimeout(() => location.reload(), 2000)
          } else {
            const msg = res.data.alert || "Update failed"
            showMobileAlert(msg, "error");
          }

        } catch (error) {
          const msg = error?.response?.data.alert || "INTERNAL SERVER ERROR"
          showMobileAlert(error, "error");
        }
      });
    });
</script>